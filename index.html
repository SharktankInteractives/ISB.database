<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISB CENTRAL COMMAND</title>
    <style>
        :root {
            --isb-red: #cc0000;
            --isb-warn: #ffcc00;
            --isb-bg: #050505;
            --isb-panel: #111;
            --isb-border: #2a2a2a;
            --text: #e0e0e0;
        }

        body { background: var(--isb-bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* ENHANCED SYNC STATUS LIGHT */
        #sync-status {
            position: fixed; 
            bottom: 20px; 
            right: 20px;
            width: 14px; 
            height: 14px; 
            border-radius: 50%;
            background: #440000; 
            border: 2px solid rgba(255,255,255,0.3);
            transition: 0.5s; 
            z-index: 9999;
        }
        .sync-online { 
            background: #00ff00 !important; 
            box-shadow: 0 0 15px #00ff00, 0 0 5px #fff; 
        }

        /* ALERT BANNER */
        #global-alert-banner {
            position: fixed; top: 0; left: 300px; right: 0;
            padding: 12px; text-align: center; font-weight: bold;
            z-index: 2000; letter-spacing: 2px; text-transform: uppercase;
            display: none; border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        .alert-critical { background: var(--isb-red); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* SIDEBAR */
        #sidebar { width: 300px; background: var(--isb-panel); border-right: 1px solid var(--isb-border); display: flex; flex-direction: column; flex-shrink: 0; }
        .header { padding: 30px 20px; border-bottom: 2px solid var(--isb-red); text-align: center; }
        nav { flex-grow: 1; overflow-y: auto; }
        nav button { width: 100%; background: none; border: none; color: #888; padding: 15px 25px; text-align: left; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: 0.2s; }
        nav button:hover, nav button.active { background: #1a1a1a; color: #fff; border-left: 4px solid var(--isb-red); }

        /* MAIN */
        #main { flex-grow: 1; padding: 60px 40px 40px; overflow-y: auto; }
        .page { display: none; max-width: 1000px; margin: 0 auto; }
        .page.visible { display: block; }
        .card { background: #0d0d0d; border: 1px solid var(--isb-border); padding: 25px; margin-bottom: 20px; border-radius: 4px; position: relative; }

        input, select, textarea { width: 100%; background: #000; border: 1px solid var(--isb-border); color: #fff; padding: 12px; margin: 10px 0; box-sizing: border-box; }
        .btn { background: var(--isb-red); color: white; border: none; padding: 12px 25px; cursor: pointer; font-weight: bold; }
        .btn-dim { background: #222; color: #aaa; border: 1px solid #333; padding: 8px 12px; cursor: pointer; font-size: 0.75rem; margin-top: 5px; }
        .btn-delete { background: #440000; color: #ff8888; border: 1px solid #660000; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; position: absolute; top: 15px; right: 15px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--isb-border); padding: 12px; text-align: left; }
        th { color: var(--isb-red); font-size: 0.75rem; text-transform: uppercase; background: #161616; }

        .hidden { display: none !important; }
    </style></head><body>

    <div id="sync-status" title="Cloud Sync Status"></div>
    <div id="global-alert-banner"></div>

    <div id="sidebar">
        <div class="header">
            <h1 style="margin:0; letter-spacing:3px; font-size:1.2rem;">ISB COMMAND</h1>
            <small style="color:var(--isb-red)">GLOBAL ENCRYPTED LINK</small>
        </div>
        <nav id="nav-links">
            <button onclick="router('public')" id="nav-public" class="active">Public Archives</button>
            <button onclick="router('onsight')" id="nav-onsight">Onsight List</button>
            <button onclick="router('blacklist')" id="nav-blacklist">Blacklist Tracker</button>
            
            <div id="secure-nav" class="hidden">
                <button onclick="router('classified')">Classified Files</button>
                <button onclick="router('ongoing')">Ongoing Cases</button>
                <button onclick="router('personnel')">Personnel Records</button>
                <button onclick="router('create')">Manage Files</button>
                <button onclick="router('manage-users')" id="nav-super" class="hidden" style="color: var(--isb-warn);">Access Management</button>
                <button onclick="router('logs')">System Logs</button>
            </div>

            <button onclick="router('login')" id="nav-login" style="margin-top:20px; color:var(--isb-red);">[ ACCESS TERMINAL ]</button>
            <button onclick="terminateSession()" id="nav-logout" class="hidden" style="color: #666;">TERMINATE SESSION</button>
        </nav>
    </div>

    <div id="main">
        <div id="page-login" class="page">
            <div class="card" style="max-width: 400px; margin: 50px auto;">
                <h3 style="text-align:center;">CREDENTIAL VERIFICATION</h3>
                <input type="text" id="user-in" placeholder="ID">
                <input type="password" id="pass-in" placeholder="CODE">
                <button class="btn" style="width:100%" onclick="login()">INITIALIZE</button>
            </div>
        </div>

        <div id="page-blacklist" class="page">
            <h2>BLACKLIST TRACKER</h2>
            <div id="blacklist-admin" class="card hidden">
                <h4>ISSUE NEW BLACKLIST ENTRY</h4>
                <input type="text" id="bl-name" placeholder="Username">
                <input type="date" id="bl-expiry">
                <input type="text" id="bl-type" placeholder="Violation Type">
                <textarea id="bl-reason" placeholder="Reason"></textarea>
                <button class="btn" onclick="addBlacklist()">ENFORCE</button>
            </div>
            <table><thead><tr><th>Subject</th><th>Violation</th><th>Reason</th><th>Expires</th><th>Action</th></tr></thead><tbody id="bl-table"></tbody></table>
        </div>

        <div id="page-onsight" class="page">
            <h2>ONSIGHT LIST (KOS/AOS)</h2>
            <div id="onsight-admin" class="card hidden">
                <h4>ISSUE ONSIGHT ORDER</h4>
                <input type="text" id="os-user" placeholder="Target Username">
                <select id="os-status"><option value="KOS">KOS (Kill on Sight)</option><option value="AOS">AOS (Arrest on Sight)</option></select>
                <input type="text" id="os-reason" placeholder="Reason">
                <input type="date" id="os-expiry">
                <button class="btn" onclick="addOnsight()">AUTHORIZE</button>
            </div>
            <table><thead><tr><th>Subject</th><th>Status</th><th>Reason</th><th>Expires</th><th>Action</th></tr></thead><tbody id="onsight-body"></tbody></table>
        </div>

        <div id="page-manage-users" class="page">
            <h2>COMMAND CONTROL</h2>
            <div class="card">
                <h4 style="color: var(--isb-warn);">PROVISION NEW OPERATIVE</h4>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-u" placeholder="User">
                    <input type="text" id="new-p" placeholder="Pass">
                    <select id="new-r"><option value="Admin">Admin</option><option value="Overseer">Overseer</option><option value="Super Admin">Super Admin</option></select>
                </div>
                <button class="btn" onclick="createUser()">AUTHORIZE</button>
            </div>
            <div class="card">
                <h4>GLOBAL BROADCAST</h4>
                <input type="text" id="alert-msg"><button class="btn" onclick="postAlert()">BROADCAST</button>
            </div>
            <div class="card">
                <h4>ACTIVE PERSONNEL</h4>
                <table><thead><tr><th>User</th><th>Rank</th><th>Action</th></tr></thead><tbody id="user-list"></tbody></table>
            </div>
        </div>

        <div id="page-public" class="page visible"><h2>PUBLIC RECORDS</h2><div id="list-public"></div></div>
        <div id="page-classified" class="page"><h2>CLASSIFIED ARCHIVES</h2><div id="list-classified"></div></div>
        <div id="page-ongoing" class="page"><h2>ACTIVE ONGOING CASES</h2><div id="list-ongoing"></div></div>
        <div id="page-personnel" class="page"><h2>PERSONNEL RECORDS</h2><div id="list-personnel"></div></div>
        <div id="page-create" class="page"><h2>FILE MANAGEMENT</h2><div class="card"><input type="text" id="f-name" placeholder="File Name"><select id="f-cat"><option value="File">General File</option><option value="Operation">Operation</option><option value="Investigation">Investigation</option><option value="Personnel">Personnel</option></select><input type="text" id="f-sec" placeholder="Y / N / O" maxlength="1"><input type="text" id="f-dept" placeholder="Dept"><input type="text" id="f-off" placeholder="Officer"><textarea id="f-info" rows="6" placeholder="Details"></textarea><button class="btn" onclick="saveFile()">ARCHIVE</button></div></div>
        <div id="page-logs" class="page"><h2>AUDIT TRAIL</h2><div id="list-logs" class="card"></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3eKgmlJzc-0uvSbOPLeUIt7XosKyOmGw",
            authDomain: "isb-command-portal.firebaseapp.com",
            projectId: "isb-command-portal",
            storageBucket: "isb-command-portal.firebasestorage.app",
            messagingSenderId: "544653655549",
            appId: "1:544653655549:web:e940243c55cf229f76ed94",
            databaseURL: "https://isb-command-portal-default-rtdb.firebaseio.com" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const initialUsers = [
            { u: "ISBCentralAdmin", p: "J!kkl@sIntelligence", r: "Super Admin" },
            { u: "voidyaepIntel", p: "K!kkl@s2025", r: "Super Admin" },
            { u: "PalpatineIsCool123", p: "AC^MZ*u]+?uNnoA%~6Y~", r: "Overseer" },
            { u: "Cry0x532", p: "ISB509126", r: "Admin" },
            { u: "Lycrosis", p: "ZAQ!2wsx", r: "Admin" },
            { u: "SANaboo", p: "NabooIsTheCoolestPlanet", r: "Admin" },
            { u: "Lunar647", p: "Starfish55@", r: "Admin" }
        ];
        let cloudUsers = [];
        let currentSession = null;

        const statusLight = document.getElementById('sync-status');
        onValue(ref(db, '.info/connected'), (snap) => {
            if (snap.val() === true) statusLight.classList.add('sync-online');
            else statusLight.classList.remove('sync-online');
        });

        onValue(ref(db, 'global_alert'), (snap) => {
            const active = snap.val();
            const banner = document.getElementById('global-alert-banner');
            if (active) {
                const diff = Date.now() - active.created;
                if (diff > 300000) { remove(ref(db, 'global_alert')); }
                else { banner.className = 'alert-critical'; banner.innerText = `${active.msg} [${Math.ceil((300000-diff)/1000)}s]`; banner.style.display = 'block'; }
            } else banner.style.display = 'none';
        });

        onValue(ref(db, 'files'), (snap) => { window.renderFilesAll(snap.val() || {}); });
        
        onValue(ref(db, 'blacklist'), (snap) => { 
            const d = snap.val() || {};
            document.getElementById('bl-table').innerHTML = Object.keys(d).map(k => `<tr><td>${d[k].name}</td><td>${d[k].type}</td><td>${d[k].reason}</td><td>${d[k].expiry}</td><td>${currentSession && currentSession.r !== 'Overseer' ? `<button class="btn-dim" style="color:red" onclick="deleteEntry('blacklist', '${k}')">X</button>` : ''}</td></tr>`).join('');
        });

        onValue(ref(db, 'onsight'), (snap) => {
            const d = snap.val() || {};
            document.getElementById('onsight-body').innerHTML = Object.keys(d).map(k => `<tr><td>${d[k].user}</td><td>${d[k].status}</td><td>${d[k].reason}</td><td>${d[k].expiry}</td><td>${currentSession && currentSession.r !== 'Overseer' ? `<button class="btn-dim" style="color:red" onclick="deleteEntry('onsight', '${k}')">X</button>` : ''}</td></tr>`).join('');
        });

        onValue(ref(db, 'users'), (snap) => { 
            const data = snap.val() || {};
            cloudUsers = Object.keys(data).map(k => ({...data[k], id: k}));
            window.renderUserTable();
        });

        onValue(ref(db, 'logs'), (snap) => {
            const l = snap.val() || {};
            document.getElementById('list-logs').innerHTML = Object.values(l).reverse().map(log => `<div style="border-bottom:1px solid #222; padding:5px; font-size:0.8rem">${log}</div>`).join('');
        });

        window.login = () => {
            const u = document.getElementById('user-in').value, p = document.getElementById('pass-in').value;
            const user = [...initialUsers, ...cloudUsers].find(x => x.u === u && x.p === p);
            if (user) {
                currentSession = user;
                window.addLog(`LOGIN: ${user.u}`);
                document.getElementById('secure-nav').classList.remove('hidden');
                document.getElementById('nav-logout').classList.remove('hidden');
                document.getElementById('nav-login').classList.add('hidden');
                if (user.r !== 'Overseer') {
                    document.getElementById('blacklist-admin').classList.remove('hidden');
                    document.getElementById('onsight-admin').classList.remove('hidden');
                }
                if (user.r === 'Super Admin') document.getElementById('nav-super').classList.remove('hidden');
                window.router('classified');
                window.renderUserTable(); 
            } else alert("ACCESS DENIED");
        };

        window.saveFile = () => {
            const f = { name: document.getElementById('f-name').value, cat: document.getElementById('f-cat').value, sec: document.getElementById('f-sec').value.toUpperCase(), dept: document.getElementById('f-dept').value, off: document.getElementById('f-off').value, info: document.getElementById('f-info').value, created: Date.now() };
            push(ref(db, 'files'), f);
            window.addLog(`FILE ARCHIVE: ${f.name} BY ${currentSession.u}`);
            window.router('public');
        };

        window.renderFilesAll = (data) => {
            const types = ['public', 'classified', 'ongoing', 'personnel'];
            types.forEach(t => {
                const container = document.getElementById('list-'+t); if(!container) return; container.innerHTML = "";
                Object.keys(data).forEach(k => {
                    const f = data[k];
                    const match = (t==='public' && f.sec==='N') || (t==='classified' && f.sec==='Y') || (t==='ongoing' && f.sec==='O') || (t==='personnel' && f.cat==='Personnel');
                    if(match) {
                        const isAdmin = (currentSession && currentSession.r !== 'Overseer');
                        container.innerHTML += `<div class="card">${isAdmin ? `<button class="btn-delete" onclick="deleteEntry('files', '${k}', '${f.name}')">PURGE</button>` : ''}<h3 style="color:var(--isb-red)">${f.name}</h3><small>${f.dept} | Status: ${f.sec}</small><p>${f.info}</p></div>`;
                    }
                });
            });
        };

        window.createUser = () => {
            const u = document.getElementById('new-u').value, p = document.getElementById('new-p').value, r = document.getElementById('new-r').value;
            if (u && p) {
                push(ref(db, 'users'), {u, p, r});
                window.addLog(`USER CREATED: ${u} RANK: ${r}`);
                document.getElementById('new-u').value = "";
                document.getElementById('new-p').value = "";
            }
        };

        window.renderUserTable = () => {
            const list = document.getElementById('user-list');
            if (!list) return;
            let html = "";
            initialUsers.forEach(u => {
                html += `<tr><td>${u.u}</td><td>${u.r}</td><td><small style="color:#444">MASTER</small></td></tr>`;
            });
            cloudUsers.forEach(u => {
                const canRevoke = currentSession && currentSession.r === 'Super Admin';
                html += `<tr><td>${u.u}</td><td>${u.r}</td><td>${canRevoke ? `<button class="btn-dim" style="color:var(--isb-red)" onclick="deleteEntry('users', '${u.id}', '${u.u}')">REVOKE</button>` : '<small>ACTIVE</small>'}</td></tr>`;
            });
            list.innerHTML = html;
        };

        window.router = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('visible'));
            document.getElementById('page-'+id).classList.add('visible');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active');
        };

        window.addBlacklist = () => push(ref(db, 'blacklist'), { name: document.getElementById('bl-name').value, expiry: document.getElementById('bl-expiry').value, type: document.getElementById('bl-type').value, reason: document.getElementById('bl-reason').value });
        window.addOnsight = () => push(ref(db, 'onsight'), { user: document.getElementById('os-user').value, status: document.getElementById('os-status').value, reason: document.getElementById('os-reason').value, expiry: document.getElementById('os-expiry').value });
        window.postAlert = () => {
            const msg = document.getElementById('alert-msg').value;
            if(msg) set(ref(db, 'global_alert'), { msg: msg, created: Date.now() });
        };
        window.addLog = (m) => push(ref(db, 'logs'), `[${new Date().toLocaleString()}] ${m}`);
        window.deleteEntry = (path, id, name) => confirm(`PURGE ${name || 'ENTRY'}?`) && remove(ref(db, `${path}/${id}`));
        window.terminateSession = () => window.location.reload();

        window.router('public');
    </script>
</body></html>
