<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISB CENTRAL COMMAND | MASTER GLOBAL</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3eKgmlJzc-0uvSbOPLeUIt7XosKyOmGw",
            authDomain: "isb-command-portal.firebaseapp.com",
            projectId: "isb-command-portal",
            storageBucket: "isb-command-portal.firebasestorage.app",
            messagingSenderId: "544653655549",
            appId: "1:544653655549:web:e940243c55cf229f76ed94",
            databaseURL: "https://isb-command-portal-default-rtdb.firebaseio.com/" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- AUTH & ACCOUNTS ---
        const hardcodedUsers = [
            { u: "ISBCentralAdmin", p: "J!kkl@sIntelligence", r: "Super Admin" },
            { u: "voidyaepIntel", p: "K!kkl@s2025", r: "Super Admin" },
            { u: "PalpatineIsCool123", p: "AC^MZ*u]+?uNnoA%~6Y~", r: "Overseer" },
            { u: "Cry0x532", p: "ISB509126", r: "Admin" },
            { u: "Lycrosis", p: "ZAQ!2wsx", r: "Admin" },
            { u: "SANaboo", p: "NabooIsTheCoolestPlanet", r: "Admin" },
            { u: "Lunar647", p: "Starfish55@", r: "Admin" }
        ];
        let currentSession = null;
        let dynamicUsers = [];

        // --- GLOBAL SYNC LISTENERS ---
        onValue(ref(db, 'global_alert'), (snap) => {
            const active = snap.val();
            const banner = document.getElementById('global-alert-banner');
            if (active) {
                const diff = Date.now() - active.created;
                if (diff > 300000) { remove(ref(db, 'global_alert')); }
                else {
                    banner.innerText = `${active.msg} [${Math.ceil((300000-diff)/1000)}s]`;
                    banner.style.display = 'block';
                }
            } else { banner.style.display = 'none'; }
        });

        onValue(ref(db, 'files'), (snap) => {
            const data = snap.val();
            renderFiles('public', data, 'N');
            renderFiles('classified', data, 'Y');
            renderFiles('ongoing', data, 'O');
            renderFiles('personnel', data, 'P');
        });

        onValue(ref(db, 'blacklist'), (snap) => {
            const data = snap.val();
            const tbody = document.getElementById('bl-table');
            tbody.innerHTML = data ? Object.keys(data).map(key => `<tr><td>${data[key].name}</td><td>${data[key].type}</td><td>${data[key].reason}</td><td>${data[key].expiry}</td></tr>`).join('') : '';
        });

        onValue(ref(db, 'onsight'), (snap) => {
            const data = snap.val();
            const tbody = document.getElementById('onsight-body');
            tbody.innerHTML = data ? Object.keys(data).map(key => `<tr><td>${data[key].user}</td><td>${data[key].status}</td><td>${data[key].reason}</td><td>${data[key].expiry}</td></tr>`).join('') : '';
        });

        onValue(ref(db, 'users'), (snap) => {
            dynamicUsers = snap.val() ? Object.keys(snap.val()).map(k => ({...snap.val()[k], id: k})) : [];
            renderUserTable();
        });

        onValue(ref(db, 'logs'), (snap) => {
            const logs = snap.val();
            document.getElementById('list-logs').innerHTML = logs ? Object.values(logs).reverse().map(l => `<div class="log-entry">${l}</div>`).join('') : 'No logs.';
        });

        // --- CORE UI RENDERING ---
        function renderFiles(divId, data, filter) {
            const container = document.getElementById('list-' + divId);
            if (!container) return;
            container.innerHTML = "";
            if (!data) return;
            Object.keys(data).forEach(key => {
                const f = data[key];
                if (f.sec === filter || (divId === 'personnel' && f.cat === 'Personnel')) {
                    const isAdmin = (currentSession && currentSession.r !== 'Overseer');
                    container.innerHTML += `
                        <div class="card">
                            ${isAdmin ? `<button class="btn-delete" onclick="deleteFile('${key}', '${f.name}')">PURGE</button>` : ''}
                            <h3 style="color:var(--isb-red)">${f.name}</h3>
                            <small>${f.dept} | Officer: ${f.off || 'Unknown'} | Status: ${f.sec}</small>
                            <p>${f.info}</p>
                        </div>`;
                }
            });
        }

        function renderUserTable() {
            const tbody = document.getElementById('user-list');
            const allUsers = [...hardcodedUsers, ...dynamicUsers];
            tbody.innerHTML = allUsers.map((u, i) => `
                <tr>
                    <td>${u.u}</td>
                    <td>${u.r}</td>
                    <td>
                        ${u.id ? `<button class="btn-dim" onclick="updateRank('${u.id}', 'Admin')">Admin</button>
                        <button class="btn-dim" style="color:red" onclick="deleteUser('${u.id}')">Revoke</button>` : '<small>Hardcoded</small>'}
                    </td>
                </tr>
            `).join('');
        }

        // --- WINDOW ATTACHED FUNCTIONS ---
        window.login = () => {
            const u = document.getElementById('user-in').value, p = document.getElementById('pass-in').value;
            const allPossible = [...hardcodedUsers, ...dynamicUsers];
            const user = allPossible.find(x => x.u === u && x.p === p);
            if (user) {
                currentSession = user;
                document.getElementById('secure-nav').classList.remove('hidden');
                document.getElementById('nav-logout').classList.remove('hidden');
                document.getElementById('nav-login').classList.add('hidden');
                if (user.r !== 'Overseer') {
                    document.getElementById('blacklist-admin').classList.remove('hidden');
                    document.getElementById('onsight-admin').classList.remove('hidden');
                }
                if (user.r === 'Super Admin') document.getElementById('nav-super').classList.remove('hidden');
                router('classified');
                window.addLog(`LOGIN: ${user.u}`);
            } else { alert("ACCESS DENIED"); }
        };

        window.createUser = () => {
            const u = document.getElementById('new-u').value, p = document.getElementById('new-p').value, r = document.getElementById('new-r').value;
            if(!u || !p) return alert("Fill all fields");
            push(ref(db, 'users'), { u, p, r });
            window.addLog(`USER CREATED: ${u} [${r}] by ${currentSession.u}`);
        };

        window.updateRank = (id, rank) => update(ref(db, `users/${id}`), { r: rank });
        window.deleteUser = (id) => remove(ref(db, `users/${id}`));

        window.saveFile = () => {
            const f = { 
                name: document.getElementById('f-name').value, 
                cat: document.getElementById('f-cat').value,
                sec: document.getElementById('f-sec').value.toUpperCase(), 
                dept: document.getElementById('f-dept').value, 
                off: document.getElementById('f-off').value,
                info: document.getElementById('f-info').value 
            };
            push(ref(db, 'files'), f);
            router('public');
        };

        window.addBlacklist = () => {
            push(ref(db, 'blacklist'), { name: document.getElementById('bl-name').value, expiry: document.getElementById('bl-expiry').value, type: document.getElementById('bl-type').value, reason: document.getElementById('bl-reason').value });
        };

        window.addOnsight = () => {
            push(ref(db, 'onsight'), { user: document.getElementById('os-user').value, status: document.getElementById('os-status').value, reason: document.getElementById('os-reason').value, expiry: document.getElementById('os-expiry').value });
        };

        window.postAlert = () => set(ref(db, 'global_alert'), { msg: document.getElementById('alert-msg').value, created: Date.now() });
        window.deleteFile = (id, name) => confirm(`Purge ${name}?`) && remove(ref(db, `files/${id}`));
        window.addLog = (m) => push(ref(db, 'logs'), `[${new Date().toLocaleString()}] ${m}`);
        window.router = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('visible'));
            document.getElementById('page-'+id).classList.add('visible');
        };
        window.terminateSession = () => window.location.reload();
    </script>
    <style>
        :root { --isb-red: #cc0000; --isb-bg: #050505; --text: #e0e0e0; }
        body { background: var(--isb-bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #global-alert-banner { position: fixed; top: 0; left: 300px; right: 0; padding: 12px; text-align: center; background: var(--isb-red); font-weight: bold; display: none; z-index: 1000; letter-spacing: 2px; }
        #sidebar { width: 300px; background: #111; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; }
        .header { padding: 30px 20px; border-bottom: 2px solid var(--isb-red); text-align: center; }
        nav button { width: 100%; background: none; border: none; color: #888; padding: 15px; text-align: left; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: 0.2s; }
        nav button:hover { background: #1a1a1a; color: #fff; border-left: 4px solid var(--isb-red); }
        #main { flex-grow: 1; padding: 60px 40px; overflow-y: auto; }
        .page { display: none; max-width: 1000px; margin: 0 auto; }
        .visible { display: block; }
        .hidden { display: none !important; }
        .card { background: #0d0d0d; border: 1px solid #2a2a2a; padding: 25px; margin-bottom: 20px; border-radius: 4px; position: relative; }
        input, textarea, select { width: 100%; background: #000; color: #fff; border: 1px solid #2a2a2a; padding: 12px; margin: 10px 0; }
        .btn { background: var(--isb-red); color: #fff; border: none; padding: 12px 25px; cursor: pointer; font-weight: bold; }
        .btn-dim { background: #222; color: #aaa; border: 1px solid #333; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; margin-right: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #2a2a2a; padding: 12px; text-align: left; }
        th { background: #161616; color: var(--isb-red); font-size: 0.75rem; text-transform: uppercase; }
        .btn-delete { position: absolute; top: 15px; right: 15px; background: #400; color: #f88; border: 1px solid #600; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; }
        .log-entry { font-size: 0.8rem; border-bottom: 1px solid #222; padding: 5px; color: #888; }
    </style>
</head>
<body>
    <div id="global-alert-banner"></div>
    <div id="sidebar">
        <div class="header"><h1>ISB COMMAND</h1><small style="color:red">GLOBAL NETWORK</small></div>
        <nav>
            <button onclick="router('public')">Public Archives</button>
            <button onclick="router('onsight')">Onsight List</button>
            <button onclick="router('blacklist')">Blacklist Tracker</button>
            <div id="secure-nav" class="hidden">
                <button onclick="router('classified')">Classified Files</button>
                <button onclick="router('ongoing')">Ongoing Cases</button>
                <button onclick="router('personnel')">Personnel Records</button>
                <button onclick="router('create')">Manage Files</button>
                <button id="nav-super" class="hidden" style="color:orange" onclick="router('manage-users')">Access Management</button>
                <button onclick="router('logs')">System Logs</button>
            </div>
            <button id="nav-login" onclick="router('login')" style="color:red; margin-top:20px;">[ ACCESS TERMINAL ]</button>
            <button id="nav-logout" class="hidden" onclick="terminateSession()">TERMINATE SESSION</button>
        </nav>
    </div>

    <div id="main">
        <div id="page-login" class="page"><div class="card" style="max-width:400px; margin:auto;"><h3>CREDENTIAL VERIFICATION</h3><input id="user-in" placeholder="ID"><input type="password" id="pass-in" placeholder="CODE"><button class="btn" style="width:100%" onclick="login()">INITIALIZE</button></div></div>
        
        <div id="page-public" class="page visible"><h2>PUBLIC RECORDS</h2><div id="list-public"></div></div>
        <div id="page-classified" class="page"><h2>CLASSIFIED</h2><div id="list-classified"></div></div>
        <div id="page-ongoing" class="page"><h2>ACTIVE ONGOING CASES</h2><div id="list-ongoing"></div></div>
        <div id="page-personnel" class="page"><h2>PERSONNEL RECORDS</h2><div id="list-personnel"></div></div>

        <div id="page-blacklist" class="page">
            <h2>BLACKLIST TRACKER</h2>
            <div id="blacklist-admin" class="card hidden">
                <h4>ISSUE BLACKLIST ENTRY</h4>
                <input id="bl-name" placeholder="Username">
                <input type="date" id="bl-expiry">
                <input id="bl-type" placeholder="Violation Type">
                <textarea id="bl-reason" placeholder="Reason"></textarea>
                <button class="btn" onclick="addBlacklist()">ENFORCE</button>
            </div>
            <table><thead><tr><th>Subject</th><th>Violation</th><th>Reason</th><th>Expires</th></tr></thead><tbody id="bl-table"></tbody></table>
        </div>

        <div id="page-onsight" class="page">
            <h2>ONSIGHT LIST</h2>
            <div id="onsight-admin" class="card hidden">
                <h4>ISSUE ONSIGHT ORDER</h4>
                <input id="os-user" placeholder="Target">
                <select id="os-status"><option value="KOS">KOS</option><option value="AOS">AOS</option></select>
                <input id="os-reason" placeholder="Reason">
                <input type="date" id="os-expiry">
                <button class="btn" onclick="addOnsight()">AUTHORIZE</button>
            </div>
            <table><thead><tr><th>Subject</th><th>Status</th><th>Reason</th><th>Expires</th></tr></thead><tbody id="onsight-body"></tbody></table>
        </div>

        <div id="page-create" class="page">
            <h2>FILE MANAGEMENT</h2>
            <div class="card">
                <input id="f-name" placeholder="File Name">
                <select id="f-cat"><option value="File">General File</option><option value="Personnel">Personnel</option></select>
                <input id="f-sec" placeholder="Status (Y/N/O/P)">
                <input id="f-dept" placeholder="Department">
                <input id="f-off" placeholder="Case Officer">
                <textarea id="f-info" placeholder="Data Documentation"></textarea>
                <button class="btn" onclick="saveFile()">ARCHIVE DATA</button>
            </div>
        </div>

        <div id="page-manage-users" class="page">
            <h2>COMMAND CONTROL</h2>
            <div class="card">
                <h4 style="color:orange">PROVISION NEW OPERATIVE</h4>
                <div style="display:flex; gap:10px;">
                    <input id="new-u" placeholder="User">
                    <input id="new-p" placeholder="Pass">
                    <select id="new-r"><option value="Admin">Admin</option><option value="Overseer">Overseer</option></select>
                </div>
                <button class="btn" onclick="createUser()">AUTHORIZE</button>
            </div>
            <div class="card">
                <h4>GLOBAL BROADCAST</h4>
                <input id="alert-msg" placeholder="Message...">
                <button class="btn" onclick="postAlert()">BROADCAST</button>
            </div>
            <div class="card">
                <h4>ACTIVE PERSONNEL</h4>
                <table><thead><tr><th>User</th><th>Rank</th><th>Action</th></tr></thead><tbody id="user-list"></tbody></table>
            </div>
        </div>

        <div id="page-logs" class="page"><h2>AUDIT TRAIL</h2><div id="list-logs" class="card"></div></div>
    </div>
</body>
</html>
